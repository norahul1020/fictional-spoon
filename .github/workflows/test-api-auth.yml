name: 🔑 API Auth Test Only

on:
  workflow_dispatch:

env:
  TENABLE_ACCESS_KEY: ${{ secrets.TENABLE_ACCESS_KEY }}
  TENABLE_SECRET_KEY: ${{ secrets.TENABLE_SECRET_KEY }}
  GOREST_API_TOKEN: ${{ secrets.GOREST_API_TOKEN || 'demo-token' }}

jobs:
  api-auth-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 🔍 Run API Auth Scan
      run: |
        cat > tenable_was.conf << 'EOF'
        "config_id"="api-auth-simple-test"
        "template_id"="web-app-scan"
        "results_visibility"=dashboard
        "vulnerability_threshold"="Medium"
        
        scan {
          assessment { enable=true }
          audit { headers=true jsons=true }
          http { "request_timeout"=30 }
          scope { "page_limit"=50 }
          timeout="00:20:00"
          
          credentials {
            "api_key" {
              "auth_headers"={
                "Authorization": "Bearer ${{ env.GOREST_API_TOKEN }}"
                "Content-Type": "application/json"
              }
              "login_check"="users"
              "login_check_url"="https://gorest.co.in/public/v2/users"
            }
          }
        }
        
        target="https://gorest.co.in/public/v2/"
        EOF
        
        docker run \
          -v $(pwd):/scanner \
          -e WAS_MODE=cicd \
          -e ACCESS_KEY="${{ env.TENABLE_ACCESS_KEY }}" \
          -e SECRET_KEY="${{ env.TENABLE_SECRET_KEY }}" \
          tenable/was-scanner:latest || true
          
    - name: 📤 Upload Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-auth-simple-results
        path: |
          tenable_was_scan.html
          scanner.log
